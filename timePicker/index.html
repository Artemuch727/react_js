<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React!</title>
	<script src="js\react.js"></script>
    <script src="js\react-dom.js"></script>
    <script src="js\browser.js"></script>
	<link rel="stylesheet" type="text/css" href="css\base.css">
 </head>

  

  <body>


<div id="content">
	
</div>
	
<script type = "text/babel">
	
// tutorial8.js
var data = [];
 
function getTasksFromLocal(){
	var resultTasks=[];
	var index=1; 

  		for (var element in localStorage){        		
			if(element.indexOf('ask')!=0){ 
    		 	
    			var TaskForExport = {
					id: JSON.parse(localStorage.getItem(element)).id ,
					person: JSON.parse(localStorage.getItem(element)).person ,
					project: JSON.parse(localStorage.getItem(element)).project ,
					task: JSON.parse(localStorage.getItem(element)).task ,
					cost: JSON.parse(localStorage.getItem(element)).cost ,
					start_dt: JSON.parse(localStorage.getItem(element)).start_dt,
					end_dt: JSON.parse(localStorage.getItem(element)).end_dt,
					active: JSON.parse(localStorage.getItem(element)).active,
					sum: JSON.parse(localStorage.getItem(element)).sum,
					elapsed: JSON.parse(localStorage.getItem(element)).elapsed
					};
    				index++;
					resultTasks.push(TaskForExport);
				 }
						
		}
			return resultTasks;
	}


var TaskBox = React.createClass({	
	getInitialState: function() {
    return {
		inputBoxVisible:false,	
		selected:{},
    	data: []};
  },

	componentDidMount: function() {
		this.setState({data : this.props.data});
	},

	handleinputBoxVisibleShowing : function(show,task){
		this.setState({inputBoxVisible : show, selected : task});
	},

	getDataFromLocalStore : function(){

	},

	handleTaskChange: function(task, type){
		var tasks = this.state.data;
	    var selectedTask = this.state.selected;
	

		 	if (type == 'ACTION_TYPE_EDIT') editSelected(this);
	   		if (type == 'ACTION_TYPE_DEL') delSelected(this);

	   	function editSelected(me){
			console.log('editComm');
			 

			localStorage.removeItem(task.id);
			localStorage.setItem(task.id , JSON.stringify(task));
			me.setState({inputBoxVisible : false});
			me.setState({data: getTasksFromLocal()});
		}

		function delSelected(me){
			console.log('delComm');
			 

			localStorage.removeItem(task.id);
			me.setState({data: getTasksFromLocal()});
		}
	},
	
	handleTaskSubmit: function(task) {
	  	
	    localStorage.setItem(task.id , JSON.stringify(task));
	    this.setState({data:  getTasksFromLocal()});
	    this.setState({inputBoxVisible : false});
		
	  },

  render: function() {     

	return (

      <div className="taskBox">
        

        <TaskList 
        		data={this.state.data} 
        		onTaskChange={this.handleTaskChange}
        		handleinputBoxVisibleShowing={this.handleinputBoxVisibleShowing}
        />
        <Sidebar 
        		handleinputBoxVisibleShowing={this.handleinputBoxVisibleShowing}
        />
        
        <TaskForm 
        		formShowing={this.state.inputBoxVisible} 
        		onTaskSubmit={this.handleTaskSubmit} 
        		onTaskChange={this.handleTaskChange}        		
        		handleinputBoxVisibleShowing={this.handleinputBoxVisibleShowing}
				task = {this.state.selected}
        />
      </div>
    );
  }
});


var Sidebar = React.createClass({
		readmoreClick: function(){		
			console.log('SidebarClick');	
		 	
			this.props.handleinputBoxVisibleShowing(true);		
		},

		render: function(){
			return (
				<div className="sidebar">
					
					<div id="task-btn_add" className="sidebar__task-btn" onClick={this.readmoreClick}>
							<p className="sidebar__label"> {"Добавить новую задачу"}</p>
					</div>				
				</div>
			)
		}
});

var TaskList = React.createClass({
  render: function() {
  var me = this;
 
    var taskNodes = this.props.data.map(function(task){
	  var handleinputBoxVisibleShowing = me.props.handleinputBoxVisibleShowing;
	  var handleTaskChange=me.props.onTaskChange;
  	 
  	return (
        <Task    
        	handleTaskChange={handleTaskChange}
			handleinputBoxVisibleShowing={handleinputBoxVisibleShowing}
			id={task.id} 
        	person={task.person} 
        	key={task.id+'_key'} 
        	project={task.project} 
        	task={task.task} 
        	elapsed={task.elapsed} 
        	active={task.active} 
        	sum={task.sum}
        	start_dt={task.start_dt} 
        	end_dt={task.end_dt} 
        	cost={task.cost}>          
        </ Task>
      	);
  	})
    return (
      <div className='taskList'>
        {taskNodes}
      </div>
    );
  }
});

 


var TaskForm = React.createClass({
	getInitialState: function() {
	    return {	    	 
	    	person: '', 
	    	project: '',
	    	cost: '', 
	    	task: ''
	    };
	  },
	  
	 
	    
	  handlePersonChange: function(e) {
	    this.setState({person: e.target.value});
	  },
	  handleProjectChange: function(e) {
	    this.setState({project: e.target.value});
	  },
	  handleCostChange: function(e) {	 
	    var reg = /\D/;
	    var result = e.target.value.match( reg );
	    result==null ? this.setState({cost: e.target.value}) :	alert('Введено не корректное число!');	     
	  },
	  handleTasksChange: function(e) {
	    this.setState({task: e.target.value});
	  },

	 	
	  handleExit: function(e) {
	  	console.log('handlExit');
		this.props.handleinputBoxVisibleShowing(false);

	  },

	  handleEdit: function(e) {
	  	console.log('handlEdit');
	  	var selectedTask = this.props.task;	  	 
	    var person = this.state.person;
	    var project = this.state.project;
	    var cost = this.state.cost;
	    var task = this.state.task;	   

	    function checkEmptyFill(before, after){
	    	if (after == '')
	    		return before
	    	else
	    		if (after !=  before)
	    			return after
	    }
	   
	    this.props.onTaskChange({
	    	id: selectedTask.id, 
	    	start_dt: selectedTask.start_dt, 
	    	person: checkEmptyFill(selectedTask.person,person), 
	    	project: checkEmptyFill(selectedTask.project,project),
	    	cost: checkEmptyFill(selectedTask.cost,cost),
	    	task: checkEmptyFill(selectedTask.task,task),
        	elapsed:selectedTask.elapsed,
        	active:selectedTask.active,
        	sum:selectedTask.sum,       	
        	end_dt:selectedTask.end_dt  	 

	    }, 'ACTION_TYPE_EDIT');
	    this.setState({person: '', project: '',cost: '', task: ''});
		this.props.handleinputBoxVisibleShowing(false);

	  },


	  handleSubmit: function(e) {	   
	    e.preventDefault();
	    var person = this.state.person;
	    var project = this.state.project;
	    var cost = this.state.cost;
	    var task = this.state.task;	  
	    var taskId = 'task-id-'+Date.now();
	    var taskStart_dt = Date.now();  	
	    var active = true; 
	    var selectedTask = this.props.task;

	    if (selectedTask != undefined) {
	    	this.handleEdit();
	    }
	    	else{	   
			    this.props.onTaskSubmit({id: taskId, start_dt: taskStart_dt, person: person, project: project,cost: cost, task: task, active:active}, 'ACTION_TYPE_ADD');
			    this.setState({person: '', project: '',cost: '', task: ''});
			}

	     
	 	
	  },
	 
	  

	 render: function() {
		 return (			 
	    	<div className ={ this.props.formShowing?'inputform-box_vis':'inputform-box_hide' }>
				<ul className="inputform-box__fieldList">				
					<li className="fieldList-item">
						<h2 className="inputform-box__title">{"Добавление(изменение) задачи"}</h2>
					</li>
					<li className="fieldList-item">
						<label for="person" className="inputform-box_vis__label">ФИО исполнителя:</label>
						<input  id="person_input" type="text" name="person" className="inputform-box__input"  value = {this.state.person} onChange={this.handlePersonChange}/>
					</li>
					<li className="fieldList-item">
						<label for="project"  className="inputform-box_vis__label">Проект:</label>
						<input id="project_input" type="text" name="project"  className="inputform-box__input" value = {this.state.project} onChange={this.handleProjectChange}/>
					</li>
					<li className="fieldList-item">
						<label for="cost"  className="inputform-box_vis__label">Ставка(р/час):</label>
						<input id="cost_input" type="text" name="cost"  className="inputform-box__input" value = {this.state.cost} onChange={this.handleCostChange}/>
					</li>
					<li className="fieldList-item">
						<label for="task"  className="inputform-box_vis__label">Комменатрии к задаче:</label>
						<textarea id="task_input" className="tasks"  name="task"  className="inputform-box__textarea" value = {this.state.task} onChange={this.handleTasksChange}></textarea>
					</li>
					<li className="inputform-box__footer">
						<p id="task-btn_save" className ="task-btn" onClick={this.handleSubmit}>{"Сохранить измененения"}</p>	
						<p id="task-btn_cancel" className ="task-btn" onClick={this.handleExit}>{"Отмена"}</p>	
					</li>
				</ul>		
			</div>			       
	    );
	  }
});
	
var Task = React.createClass({
	getInitialState: function(){	
		 
		var elapsed =0;		 
		this.props.elapsed ? elapsed = this.props.elapsed : elapsed = 0;

		return {						
			end_dt: this.props.end_dt,
			inProcess: this.props.active,
			elapsedTime: elapsed
		}
	},

	stopTimer: function(){
			
			var now = new Date().getTime();					
			this.setState({
							inProcess:false,
							elapsedTime: this.state.elapsedTime  - this.state.end_dt + now,							
							end_dt:now
						});
			 	
	},

	startTimer: function(){
				
			var now = new Date().getTime();
			this.setState({
							inProcess:true,			
							elapsedTime: this.state.elapsedTime,				 
							end_dt:now
						});

				 
				 
		},

	handleInProcessChange: function(){ 

		var currState = this.state.inProcess;
		currState ? this.stopTimer(): this.startTimer();	 


	},


	handleEdit: function(){
		console.log('handleEdit');
		var handleinputBoxVisibleShowing = this.props.handleinputBoxVisibleShowing;
		var setSelected = {
						id:this.props.id,
						person:this.props.person,
						project:this.props.project,
						task:this.props.task,	
						cost:this.props.cost,
						active:this.state.inProcess,
						elapsed:this.state.elapsedTime,
						end_dt:this.state.end_dt
						}
		this.props.handleinputBoxVisibleShowing(true, setSelected);
	},


	handleDelete : function(){
		console.log('handleDelete');
		var confirmation = confirm('Вы уверены что хотите удалить задачу?');
		
		if (confirmation){
		var handleinputBoxVisibleShowing = this.props.handleinputBoxVisibleShowing;
		var setSelected = {
						id:this.props.id,
						person:this.props.person,
						project:this.props.project,
						task:this.props.task,	
						cost:this.props.cost
						}
		 
		this.props.handleTaskChange(setSelected, 'ACTION_TYPE_DEL');
		 }
	},

	
  	render: function() {

  	
  
  	 var elapsed = this.state.elapsedTime;  	 
  	 var currState = this.state.inProcess;
  	 var costPerHour = this.props.cost;
  	
 	 var sum = costPerHour * (elapsed/(1000*60*60));

		var setSelected = {
						id:this.props.id,
						person:this.props.person,
						project:this.props.project,
						task:this.props.task,	
						cost:this.props.cost,
						active: this.state.inProcess,
						elapsed: this.state.elapsedTime,
						end_dt:this.state.end_dt,
						start_dt:this.props.start_dt,
						sum: sum
						};

			localStorage.removeItem(setSelected.id);
			localStorage.setItem(setSelected.id , JSON.stringify(setSelected));

	 
     return (
      
      			<div  className="task-area">					
					<div className="task-header">
						<div> {"ФИО: "+this.props.person} </div>
						<div> {"Проект: "+this.props.project} </div>
						<div className="task-header__icon_del" onClick={this.handleDelete}> </div>
					</div>

					 
					
					<div className="task-area__text-field">{"Комменатрии к задаче: " +this.props.task}</div>
					<div className="task-area__text-field">{"Ставка(в час): "+this.props.cost+" руб."}</div>
					<div className="task-area__text-field">{"Затрачено: " + (elapsed/(1000*60*60)).toFixed(2) +" часа"} </div>	
					<div className="task-area__text-field">{"Сумма: "+sum.toFixed(2)+" руб."}</div>
					<div className="task-area__text-field">{ currState ? 'Выполняется...' : 'Выполнены' }</div>
					
						<div className="task-area__footer">
							<div className="task-btn" onClick={this.handleInProcessChange}> Изменить статус </div>
							<div className="task-btn" onClick={this.handleEdit}> Редактировать </div>
						</div>
					 
				</div>


    );
  }
});	 

ReactDOM.render(
			<TaskBox data={getTasksFromLocal()}/>,
			document.getElementById('content') 
			);

	</script> 

  </body>



